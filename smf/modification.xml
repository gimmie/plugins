<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
  <id>gimmie:GimmieRewards</id>
  <version>1.0</version>

  <file name="$languagedir/Modifications.english.php">
    <operation>
      <search position="end" />
      <add>
        <![CDATA[
        $txt['gmss_title'] = 'Gimmie Rewards';
        $txt['gmss_gimmie_rewards'] = 'Gimmie Rewards';
        $txt['gmss_gimmie_button'] = 'Rewards';
        ]]>
      </add>
    </operation>
  </file>
  
  <file name="$themedir/index.template.php">
  	<operation>
  	  <search position="after" whitespace="loose">
    	  <![CDATA[// Here comes the JavaScript bits!]]>
  	  </search>
  	  <add>
  	    <![CDATA[
Gimmie_rewards_script();
  	    ]]>
  	  </add>
  	</operation>
  	<operation>
  	  <search position="after" whitespace="loose"><![CDATA[</body></html>]]></search>
  	  <add>
    	  <![CDATA[<div id="gimmie-root"></div>]]>
  	  </add>
  	</operation>
  	<operation>
  	  <search position="end" />
  	  <add>
    	  <![CDATA[
// Gimmie Rewards
function Gimmie_rewards_script() {
	global $context, $settings, $options, $scripturl, $txt, $modSettings, $user_info;
	
	$themeurl = $settings['theme_url'];
	$user = $context['user'];
	
	$endpoint = $scripturl."?action=gmpx;sa=";
	$key = $modSettings['gm_key'];
	$notification_timeout = isset($modSettings['gm_notification_timeout']) ? $modSettings['gm_notification_timeout'] : 10;
	
	
	$country = '';
	
	if (!isset($modSettings['gm_country']) || $modSettings['gm_country'] == 'auto') {
	  $ip = isset($user_info['ip2']) ? $user_info['ip2'] : $user_info['ip'];
    $country = trim(file_get_contents('http://api.wipmania.com/'.$ip));
	}
	else {
	  $country = $modSettings['gm_country'];
	}
	
  echo <<<EOH
  <link href="//cdnjs.cloudflare.com/ajax/libs/select2/3.4.5/select2.css" rel="stylesheet" />
  <link href="$themeurl/css/GimmieRewards.css" rel="stylesheet" />
  
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/select2/3.4.5/select2.js"></script>
  <script type="text/javascript">
    $(document).ready(function () {
      $(".gimmie .gm-select").select2();
    });
  </script>
EOH;
	
	if (!$modSettings['gm_enable']) {
  	return;
	}
	
  echo <<<EOS
  <script type="text/javascript">
    _gimmie = {
      "endpoint"                    : "$endpoint",
      "key"                         : "$key",
      "country"                     : "$country",
      
EOS;
  if (!$user['is_guest']) {
    $email = $user['email'];
    $username = $user['usrname'];
    $name = $user['name'];
    echo <<<EOU
    
      "user"                        : {
        "external_uid"              : "$email",
        // Display name
        "name"                      : "$username",
        // Gateway name
        "realname"                  : "$name",
        "email"                     : "$email",
        "avatar"                    : ""
      },
      
EOU;
  }
echo <<<EOS

      "options"                     : {
        "animate"                   : true,
        "auto_show_notification"    : true,
        "push_notification"         : true,
        "notification_timeout"      : $notification_timeout,
        "responsive"                : true,
        "show_anonymous_rewards"    : true,
        "shuffle_reward"            : true
      },
      "templates"                   : {}
    };
    
    $(document).ready(function () {
      (function(d){
        var js, id = "gimmie-widget", ref = d.getElementsByTagName("script")[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement("script"); js.id = id; js.async = true;
        js.src = "http://api.llun.in/assets/gimmie-widget2.all.js";
        ref.parentNode.insertBefore(js, ref);
      }(document));
    });
  </script>
EOS;

}
    	  ]]>
  	  </add>
  	</operation>
  </file>

  <file name="$boarddir/index.php">
    <operation>
   		<search position="before" whitespace="loose"><![CDATA['admin' => array('Admin.php', 'AdminMain'),]]></search>
      <add><![CDATA[
        'gmpx' => array('Subs-GimmieRewards.php', 'gimmie_proxy'), // Proxy
        'gmss' => array('Subs-GimmieRewards.php', 'gimmie_reward_config'), // Configuration Action
        ]]></add>
    </operation>
  </file>

  <file name="$sourcedir/Admin.php">
    <operation>
      <search position="after" whitespace="loose"><![CDATA[
'layout' => array(
                        'title' => $txt['layout_controls'],]]>
      </search>
      <add>
        <![CDATA[
        'gmss' => array(
          'title' => $txt['gmss_title'],
          'permission' => array('admin_forum'),
          'areas' => array(
            'gmss' => array(
              'label' => $txt['gmss_gimmie_rewards'],
              'file' => 'Subs-GimmieRewards.php',
              'function' => 'gimmie_reward_config',
              'custom_url' => $scopeurl.'?action=admin;area=gmss;sa=settings;secs='.$sc
            )
          )
        ),
        ]]>
      </add>
    </operation>
  </file>

  <file name="$sourcedir/Subs.php">
    <operation>
      <search position="after" whitespace="loose"><![CDATA['help' => array(]]></search>
      <add>
        <![CDATA[
        'gimmie' => array(
          'title' => $txt['gmss_gimmie_button'],
          'href' => 'javascript:GimmieWidget._showPopup(\'catalog\')',
          'show' => true,
          'sub_buttons' => array(),
        ),
        ]]>
      </add>
    </operation>
  </file>
</modification>

