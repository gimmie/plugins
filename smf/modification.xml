<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
  <id>gimmie:GimmieRewards</id>
  <version>1.0</version>

  <file name="$languagedir/Modifications.english.php">
    <operation>
      <search position="end" />
      <add>
        <![CDATA[
        $txt['gmss_title'] = 'Gimmie Rewards';
        $txt['gmss_gimmie_rewards'] = 'Gimmie Rewards';
        $txt['gmss_gimmie_button'] = 'Rewards';
        ]]>
      </add>
    </operation>
  </file>
  
  <file name="$themedir/index.template.php">
  	<operation>
  	  <search position="after" whitespace="loose">
    	  <![CDATA[// Here comes the JavaScript bits!]]>
  	  </search>
  	  <add>
  	    <![CDATA[
Gimmie_rewards_script();
  	    ]]>
  	  </add>
  	</operation>
  	<operation>
  	  <search position="after" whitespace="loose"><![CDATA[</body></html>]]></search>
  	  <add>
    	  <![CDATA[<div id="gimmie-root"></div><script id="gimmie-widget" type="text/javascript" src="//api.gimmieworld.com/assets/gimmie-widget2.all.js"></script>]]>
  	  </add>
  	</operation>
  	<operation>
  	  <search position="end" />
  	  <add>
    	  <![CDATA[
// Gimmie Rewards
function Gimmie_rewards_script() {
	global $context, $settings, $options, $scripturl, $txt, $modSettings;
	
	$themeurl = $settings['theme_url'];
	$key = $modSettings['gm_key'];
	$endpoint = $scripturl."?action=gmpx;sa=";
	
  echo <<<EOH
  <link href="//cdnjs.cloudflare.com/ajax/libs/select2/3.4.5/select2.css" rel="stylesheet" />
  <link href="$themeurl/css/GimmieRewards.css" rel="stylesheet" />
  
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/select2/3.4.5/select2.js"></script>
EOH;
	
	if (!$modSettings['gm_enable']) {
  	return;
	}
	
  echo <<<EOS
  <script type="text/javascript">
    _gimmie = {
      "endpoint"                    : "$endpoint",
      "key"                         : "$key",
      "country"                     : "global",
      "options"                     : {
        "animate"                   : true,
        "auto_show_notification"    : true,
        "push_notification"         : true,
        "notification_timeout"      : 60,
        "responsive"                : true,
        "show_anonymous_rewards"    : true,
        "shuffle_reward"            : true
      },
      "templates"                   : {}
    };
  </script>
EOS;

  if (!$context['user']['is_guest']) {
    $email = $context['user']['email'];
  
    echo <<< EOU
    <script type="text/javascript">
    _gimmie.user = {
      "external_uid"              : "$email",
      // Display name
      "name"                      : "jenny",
      // Gateway name
      "realname"                  : "Real Username",
      "email"                     : "$email",
      "avatar"                    : ""
    }
    </script>
EOU;
  }
}
    	  ]]>
  	  </add>
  	</operation>
  </file>

  <file name="$boarddir/index.php">
    <operation>
   		<search position="before" whitespace="loose"><![CDATA['admin' => array('Admin.php', 'AdminMain'),]]></search>
      <add><![CDATA[
        'gmss' => array('Subs-GimmieRewards.php', 'gimmie_reward_config'), // Configuration Action
        'gmpx' => array('Subs-GimmieRewards.php', 'gimmie_proxy'), // Proxy
        ]]></add>
    </operation>
  </file>

  <file name="$sourcedir/Admin.php">
    <operation>
      <search position="after" whitespace="loose"><![CDATA[
'layout' => array(
                        'title' => $txt['layout_controls'],]]>
      </search>
      <add>
        <![CDATA[
        'gmss' => array(
          'title' => $txt['gmss_title'],
          'permission' => array('admin_forum'),
          'areas' => array(
            'gmss' => array(
              'label' => $txt['gmss_gimmie_rewards'],
              'file' => 'Subs-GimmieRewards.php',
              'function' => 'gimmie_reward_config',
              'custom_url' => $scopeurl.'?action=admin;area=gmss;sa=settings;secs='.$sc
            )
          )
        ),
        ]]>
      </add>
    </operation>
  </file>

  <file name="$sourcedir/Subs.php">
    <operation>
      <search position="after" whitespace="loose"><![CDATA['help' => array(]]></search>
      <add>
        <![CDATA[
        'gimmie' => array(
          'title' => $txt['gmss_gimmie_button'],
          'href' => 'javascript:GimmieWidget._showPopup(\'catalog\')',
          'show' => true,
          'sub_buttons' => array(),
        ),
        ]]>
      </add>
    </operation>
  </file>
</modification>

